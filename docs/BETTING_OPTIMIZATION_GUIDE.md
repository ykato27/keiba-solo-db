# 馬券配分最適化ガイド
## Kelly基準を使用した期待収益最大化

---

## 📚 概要

このガイドは、**Kelly基準** を使用して馬券の最適な配分を計算し、期待収益を最大化する方法を説明しています。

### 🎯 提供される機能

1. **バックテスト** - 過去レースでモデルを検証
2. **モデル訓練** - 機械学習モデルを訓練
3. **将来レース予測** - 未来のレースを予測
4. **馬券配分推奨** - Kelly基準で最適配分を計算

---

## 🎲 Kelly基準とは

### 定義

Kelly基準（Kelly Criterion）は、確率ゲームで資金を最大化するための数学的手法です。

```
f* = (b×p - q) / b

ここで：
f*  = 投資額の最適な割合（0～1）
b   = オッズ（配当倍率）
p   = 勝つ確率
q   = 負ける確率（1-p）
```

### 例

**ケース: 50%の確率で2倍になるレース**

```
b = 2.0
p = 0.5
q = 0.5

f* = (2.0 × 0.5 - 0.5) / 2.0
   = (1.0 - 0.5) / 2.0
   = 0.5 / 2.0
   = 0.25 (25%)

→ 全額の25%を賭ける
```

**予算 10,000円の場合:**
```
推奨賭金 = 10,000 × 0.25 = 2,500円
```

---

## 💡 実装の特徴

### 1. セーフティファクター（安全係数）

**Full Kelly** だけでは資金が過剰に投下される可能性があるため、セーフティファクターを適用しています：

```python
safe_kelly = kelly * safety_factor
# safety_factor = 0.25 （つまり、Kelly値の25%を実装）
```

**例:**
- Kelly基準: 20%
- 実装: 20% × 0.25 = **5%** を賭ける

### 2. 期待値のチェック

赤字になるような賭けは自動的に除外されます：

```
期待値 = (オッズ - 1) × 勝つ確率 - 負ける確率

例: オッズ2.0, 確率40%
期待値 = 1.0 × 0.4 - 0.6 = -0.2 (負)
→ 賭けない
```

### 3. 複数予算シナリオ

異なる投資額で推奨配分を計算できます：

```
- 1,000円
- 5,000円
- 10,000円
- 50,000円
- 100,000円
```

各シナリオで最適な配分を提示します。

---

## 🔍 使用方法

### Streamlit UI での操作

#### Tab 1: バックテスト

1. 開始日・終了日を選択
2. 「バックテストを実行」をクリック
3. 結果を確認

**表示される情報:**
- 総レース数
- 1着予測的中率
- 2-3着予測的中率

#### Tab 2: モデル訓練

1. モデルを選択（LightGBM推奨）
2. 訓練データ期間を選択（30-365日）
3. 「モデルを訓練」をクリック

**表示される情報:**
- 平均精度
- F1スコア
- Fold別詳細

#### Tab 3: 将来レース予測

1. レースを選択
2. 「予測を実行」をクリック
3. 予測結果を確認

**表示される情報:**
- 各馬の勝つ確率
- 馬券配分推奨へ自動遷移

#### Tab 4: 馬券配分推奨

1. 投資予算シナリオを選択（複数選択可）
2. 「最適配分を計算」をクリック
3. 各シナリオの推奨配分を確認

**表示される情報:**
- 各馬への推奨賭金
- 期待ROI（投資収益率）
- 期待利益
- ポートフォリオ統計

---

## 📊 出力例

### 予算 10,000円での推奨

```
Horse A
  勝つ確率: 50%
  配分割合: 6.82%
  推奨賭金: 682円
  期待ROI: +10.00%
  期待利益: +68円

Horse B
  勝つ確率: 35%
  配分割合: 3.33%
  推奨賭金: 333円
  期待ROI: +5.00%
  期待利益: +17円

ポートフォリオ統計:
  総投資額: 1,015円
  期待利益: +85円
  期待ROI: +8.37%
  対象馬数: 2
```

---

## ⚠️ 重要な注意事項

### 1. 期待値がプラスであることが必須

Kelly基準は、**期待値がプラスの場合のみ有効**です。

```
期待値 > 0 であることを確認
```

### 2. オッズの信頼性

推奨配分は **予測精度とオッズの正確性に依存**します。

- 予測精度が低い → 推奨は信頼できない
- オッズが不正確 → 期待値計算が狂う

### 3. 短期的な変動

Kelly基準は **長期的な资金成長** を最適化します。短期的には赤字になる可能性があります。

### 4. セーフティファクター

安全性を重視する場合は、セーフティファクターを調整：

```python
optimizer.calculate_kelly_fraction(
    win_probability=0.5,
    expected_odds=2.0,
    safety_factor=0.1  # より保守的
)
```

---

## 🔧 Python API の使用

### 基本的な使用例

```python
from app.betting_optimizer import BettingOptimizer

# データ準備
predictions = [
    {
        'horse_name': '馬1',
        'win_probability': 0.50,
        'expected_odds': 2.2
    },
    {
        'horse_name': '馬2',
        'win_probability': 0.35,
        'expected_odds': 3.0
    },
]

# オプティマイザー初期化
optimizer = BettingOptimizer()

# 最適配分を計算
budget = 10000
recommendations = optimizer.optimize_portfolio(
    predictions,
    total_budget=budget,
    min_probability=0.05
)

# 結果を表示
for rec in recommendations:
    print(f"{rec.horse_name}: {rec.kelly_bet:.0f}円")
```

### Kelly基準の単独計算

```python
kelly_fraction = optimizer.calculate_kelly_fraction(
    win_probability=0.50,
    expected_odds=2.2,
    safety_factor=0.25
)
# → 0.0682 (6.82%)
```

### 複数予算シナリオ

```python
scenarios = optimizer.generate_scenario_recommendations(
    predictions,
    budgets=[1000, 5000, 10000, 50000]
)

for budget, recommendations in scenarios.items():
    print(f"\n予算: {budget}円")
    for rec in recommendations:
        print(f"  {rec.horse_name}: {rec.kelly_bet:.0f}円")
```

---

## 📈 期待値の計算

### 公式

```
期待値 = (勝つ場合の利益) × 勝つ確率 - (賭け額) × 負ける確率
      = (オッズ - 1) × 賭け額 × 勝つ確率 - 賭け額 × 負ける確率
```

### 例

```
オッズ: 2.5, 確率: 40%, 賭け額: 1000円

期待値 = (2.5 - 1) × 1000 × 0.4 - 1000 × 0.6
       = 1.5 × 1000 × 0.4 - 600
       = 600 - 600
       = 0 (ブレークイーブン)
```

---

## 🎯 推奨される使用フロー

### 1日のワークフロー

```
朝:
  1. バックテストを実行（精度確認）
  2. モデルを再訓練（最新データで更新）

レース前:
  3. 将来レース予測を実行
  4. Kelly基準で馬券配分を計算
  5. 複数予算シナリオを確認

レース終了後:
  6. バックテストで検証
  7. パラメータ調整（必要に応じて）
```

---

## 📚 参考資料

### Kelly基準について

- 原著: "A New Interpretation of Information Rate" (J.L. Kelly Jr., 1956)
- 現代的応用: 投資管理、確率ゲーム、機械学習

### 競馬に特化した注意点

1. **オッズは時間とともに変動** - 最新オッズを使用
2. **予測精度は重要** - 小さい確率差が大きな差を生む
3. **分散化が重要** - 複数の馬に配分（卵を全部一つの籠に入れない）

---

## 💬 質問・トラブル

### Q: Kelly基準で損しない?

**A:** いいえ。Kelly基準は **期待値がプラスの場合、長期的に資金を最大化する** 方法です。短期的には損をする可能性があります。

### Q: セーフティファクターはいくつが良い?

**A:** 推奨は0.25（Kelly値の25%）です。
- 積極的: 0.5 (50%)
- 保守的: 0.1 (10%)

### Q: 複数レースに同時投資できる?

**A:** はい。各レースで独立して計算し、合計予算を配分してください。

---

**最終更新**: 2025-11-08
